
交易任务面板
--------------
功夫交易系统目前提供“条件单”、“excel下单”、“冰山”、“TWAP”四种交易任务，用户可使用交易任务自动化下单。

(1) 点击“交易任务”面板 “添加”按钮。

.. image:: _images/交易任务面板.png

.. image:: _images/交易任务-27.png


(2) 选择想使用的交易任务，点击确定。

.. image:: _images/2.5交易任务(支持暂停重启).png

.. hint:: 
   - 交易任务支持暂停、重启功能
   - 重启进程后，当系统检测到未到达结束时间的情况下，将按剩余时间、未完成量重新计算单次下单量继续完成下单任务


-----


条件单
~~~~~~~~~~~~

.. note:: 允许设置 **价格/时间** 条件。
  - **仅设置价格条件时** ，仅在价格条件触发时下单。

  - **仅设置时间条件时** ，仅在到达目标设定时间点时下单。

  - **价格条件跟时间条件同时存在** 时，按满足的先后顺序下单。如价格条件一直未满足，到达时间条件设定的时刻将触发下单。

  - **设置多个价格条件** ，设置多个价格条件时，条件均满足才会触发下单。

.. image:: _images/条件单.png


.. note:: 填写条件单参数请参考以下表格。

.. list-table::
   :header-rows: 1

   * - 字段
     - 字段说明
   * - 账户
     - 选择下单账户
   * - 行情
     - 选择行情源
   * - 标的
     - 选择下单标的
   * - 买卖
     - 选择交易方向：买or卖
   * - 开平
     - 选择交易方向：开or平or平今or平昨
   * - 下单类型
     - 选择报单方式，如限价/市价
   * - 价格条件
     - 非必填，允许设置多个价格条件，设置多个价格条件时，条件均满足才会触发下单
   * - 下单价格
     - 触发条件后下单的价格，允许从最新价、对手一档、我方一档中选择
   * - 数量
     - 触发条件后下单的数量
   * - 单次最大手数
     - 单次下单最大数量，将以此为基础进行拆单，不填则表示柜台无限制, 股票请填100的整数倍, 否则自动向下取整, 小于100则会强制设成100
   * - 触发时间
     - 非必填，填写则到达此时间自动下单


-----


Excel下单
~~~~~~~~~~~~

如果需要实现多标的定时下单，可选用此交易任务。

.. image:: _images/excel下单.png

.. attention:: 
   - 使用Excel下单请注意
  
   1. 行情源将自动选择与交易账户相同的柜台。
   2. Excel文件目前只支持一个sheet表。
   3. 当excel表内所有标的下单执行完成后，该交易任务进程将自动关闭。




.. note:: 填写Excel下单表格，请参考以下表格。


.. list-table::
   :header-rows: 1

   * - 字段
     - 字段说明
   * - time
     - 下单时间，格式为 HH：mm：ss （24小时制，时分秒皆占两位），例：01：02：03
   * - instrument_id
     - 标的ID
   * - exchange_id
     - 交易所ID，如上交所SSE
   * - limit_price
     - 报单价格
   * - volume
     - 下单数量
   * - price_type
     - 报单类型，可填 Limit、Any、FakBest5、ForwardBest、ReverseBest、Fak、Fok。请参考API文档“PriceType对象”
   * - side
     - 买卖
   * - offset
     - 可填 Buy、Sell、Lock、Unlock、Exec、Drop、MarginTrade、ShortSell、RepayMargin、RepayStock。请参考API文档“Side 买卖”
   * - hedge_flag
     - 投机套保标识，非必填，默认为Speculation投机
   * - is_swap
     - 互换标识，非必填，可填 True 或 False，默认为 False


-----


冰山
~~~~~~~~~~~~~~
当下单总量极大，为了分散成交量以减小对市场冲击时，建议选用冰山交易任务。

.. attention:: 
    - 对于冰山交易任务，委托全部成交，才会触发下一次下单。
    - 因此如果上一单暂未全部成交，即使行情价格满足，系统仍然不会下出新单。


.. image:: _images/冰山.png

.. note:: 填写冰山下单参数，请参考以下表格

.. list-table::
   :header-rows: 1

   * - 字段
     - 字段说明
   * - 账户
     - 选择下单账户
   * - 标的
     - 选择下单标的
   * - 买卖
     - 选择交易方向：买or卖
   * - 开平
     - 选择交易方向：开or平or平今or平昨
   * - 目标价格
     - 填写目标价格，当行情到达目标价格时将下单
   * - 委托暴露量
     - 当行情到达目标价格时下单的数量
   * - 每轮间隔
     - 触发条件后下单的价格，允许从“最新价、对手一档价、我方一档价”中选择
   * - 数量
     - 下单总量
   * - 单次最大手数
     - 单次下单最大数量，将以此为基础进行拆单，不填则表示柜台无限制， 股票请填100的整数倍， 否则自动向下取整， 小于100则会强制设成100
   * - 触发时间
     - 非必填，填写则到达此时间自动下单


-----


TWAP剩余累积
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
想分散成交量、提高成交概率时，建议选用TWAP交易任务（在设定的时间范围内匀速下单）。

.. note:: 功夫内置2种TWAP，可按需取用，其区别在于补单计算方法、最后一单完成方法。

   （1）TWAP剩余累积将上一单未完成的部分累积到下一次下单中。而TWAP剩余平均会将上一单未完成的部分平均分到剩余次数中；

   （2）TWAP剩余累积最后一单无论是否全部成交，在到达结束时间时会撤单。而TWAP剩余平均最后一单将以涨停价（买）/跌停价（卖）报出委托单，且结束时间到达后不会撤单，力求完成下单总数。

    - **例：补单计算方法**：目前单次下单数为200，TWAP运行一段时间后，剩余下单次数为5，剩余待下出数量为1000，上一次下单200手未完全成交，剩余100手，TWAP撤单上一次下单，将进行下一次下单。

      TWAP剩余累积下一次下单手数：单次下单数 200 + 上次未完成的数量 200-100 = 300手
   
      TWAP剩余平均下一次下单手数：（单次下单数 200 + 总共未完成的数量 200-100+1000 ） / 剩余下单次数 5 = 1300/5 = 260手




系统将根据用户设置的参数计算下单次数，当单次下单量 > 单次最大手数 时，将下单单次最大手数；剩余部分将累积到下次下单时一起下出。

.. image:: _images/TWAP剩余累积下单次下单数公式.png


.. image:: _images/twap单剩余累积.png


.. note:: 填写TWAP下单参数，请参考以下表格

.. list-table::
   :header-rows: 1

   * - 字段
     - 字段说明
   * - 账户
     - 选择下单账户
   * - 行情
     - 选择行情源
   * - 标的
     - 选择下单标的
   * - 买卖
     - 选择交易方向：买or卖
   * - 开平
     - 选择交易方向：开or平or平今or平昨；
   * - 价格
     - 填写目标价格，允许从“最新价、对手价一档、同方向一档、对手价自定义、同方向自定义”中选择
   * - 档位价差
     - 允许下单时价格与设定价格有一定偏移 。 仅当价格选择“对手价自定义、同方向自定义”时，本参数有效。正数表示更激进， 负数表示更保守; 
   * - 下单方式
     - 可填 Limit、Any、FakBest5、ForwardBest、ReverseBest、Fak、Fok。请参考API文档“PriceType对象”
   * - 下单总量
     - 期望完成的下单数量
   * - 单次最小下单量
     - 当本次下单量≥单次最小下单量时，才会触发下单，未触发下单时，本次下单量将累积到下一次下单量计算中
   * - 开始时间
     - 交易任务开始的时间
   * - 盘休时间列表
     - 计算步数时，将扣除盘休时间，非必填
   * - 结束时间
     - 交易任务结束时间，当结束时间到达时，若最后一次委托未全部成交，将被撤单
   * - 下单间隔
     - 下单频率，单位为秒。   
   * - 单次最大手数
     - 最大单次下单量，当计算出本次下单量≥单次最大手数时，下单数量为单次最大手数
   * - 挤压报警率
     - 未成交数量/应已成交量大于设置的挤压报警率时，进程状态将显示“异常”（交易任务仍然会正常执行），且报警提示音响起
   * - 平完反向开
     - 期货可开启此配置；开启后，当平仓数量 > 当次下单数时，将先平完剩余仓位，再反向开仓以锁定利润 



.. attention::
   1. 当上一委托未全部成交，到达下一下单时间点时，系统将先撤单未完成的委托，并将未完成的数量加到下一次下单数量中。

    如第一步下单数量为1000， 第二步下单时间到时，第一步只成交了500手， 系统将先撤单， 第二步下单量= 1000 + 500 = 1500 。

   2. 如果每步下单量小于设置的单次最小下单量，则不会下单，下单量将累积到下一步。

    如：下单总量为500， 总时间为1min， 时间间隔为7秒， 60/7=8.57，即 计算得到总步数为10， 单次下单量=500/10=50，因此第一步下单量50小于最小下单量100， 则第一步将取消下单， 把下单量累积到第二步，第二步下单量= 50+50=100 。

   3. 单次最大手数: 柜台允许的单次最大手数，将以此为基础进行拆单，不填则表示柜台无限制，股票请填100的整数倍，否则自动向下取整。


-----


TWAP剩余平均
~~~~~~~~~~~~~~~~~~~~~~~~~~~

想分散成交量、提高成交概率时，建议选用TWAP交易任务（在设定的时间范围内匀速下单）。

.. note:: 功夫内置2种TWAP，可按需取用，其区别在于补单计算方法、最后一单完成方法。

   （1）TWAP剩余累积将上一单未完成的部分累积到下一次下单中。而TWAP剩余平均会将上一单未完成的部分平均分到剩余次数中；

   （2）TWAP剩余累积最后一单无论是否全部成交，在到达结束时间时会撤单。而TWAP剩余平均最后一单将以涨停价（买）/跌停价（卖）报出委托单，且结束时间到达后不会撤单，力求完成下单总数。

    - **例：补单计算方法**：目前单次下单数为200，TWAP运行一段时间后，剩余下单次数为5，剩余待下出数量为1000，上一次下单200手未完全成交，剩余100手，TWAP撤单上一次下单，将进行下一次下单。

      TWAP剩余累积下一次下单手数：单次下单数 200 + 上次未完成的数量 200-100 = 300手
   
      TWAP剩余平均下一次下单手数：（单次下单数 200 + 总共未完成的数量 200-100+1000 ） / 剩余下单次数 5 = 1300/5 = 260手


系统将根据用户设置的参数计算单次下单数。

.. image:: _images/TWAP剩余平均单次下单数公式.png


.. image:: _images/twap单剩余平均.png


.. note:: 填写TWAP下单参数，请参考以下表格

.. list-table::
   :header-rows: 1

   * - 字段
     - 字段说明
   * - 账户
     - 选择下单账户
   * - 行情
     - 选择行情源
   * - 标的
     - 选择下单标的
   * - 买卖
     - 选择交易方向：买or卖
   * - 开平
     - 选择交易方向：开or平or平今or平昨；
   * - 价格
     - 填写目标价格，允许从“最新价、对手价一档、同方向一档、对手价自定义、同方向自定义”中选择
   * - 保护价格
     - 保护价格为0时，视作不使用保护价格；填入非0正数时，当买卖=买，当行情价格高于保护价格，则以保护价格下单，否则以行情价格下单；反之买卖=卖时,当行情低于保护价格时，以保护价格下单，否则以行情价格下单
   * - 下单总量
     - 期望完成的下单数量
   * - 下单总量
     - 期望完成的下单数量
   * - 开始时间
     - 交易任务开始的时间
   * - 结束时间
     - 交易任务结束时间，当结束时间到达前，最后一次委托将以涨停价（买）/跌停价（卖）报单，结束时间到达后也不会撤单。
   * - 下单间隔
     - 下单频率，单位为秒。   
   * - 单次最大手数
     - 最大单次下单量，当计算出本次下单量≥单次最大手数时，下单数量为单次最大手数
   * - 挤压报警率
     - 未成交数量/应已成交量大于设置的挤压报警率时，进程状态将显示“异常”（交易任务仍然会正常执行），且报警提示音响起

-----

